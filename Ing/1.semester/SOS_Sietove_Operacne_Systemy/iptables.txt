#!/bin/bash

I=/sbin/iptables

# Vyčistíme pôvodné pravidlá z tabuliek NAT a FILTER
$I -F -t filter
$I -F -t nat

# Používame reštriktívnu politiku:
# čo nie je vyslovene povolené, je zakázané
$I -P INPUT DROP
$I -P FORWARD DROP
#$I -P INPUT ACCEPT
#$I -P FORWARD ACCEPT

# Povolíme vstup na loopback pre firewall
$I -A INPUT -i lo -j ACCEPT

########## CONNTRACK ##########
# CONNTRACK mení bezstavový firewall na stavový t.j. firewall si pamätá spojenia,
# ktoré boli inicializované z vnútornej siete smerom von a automaticky ich povolí
# zvonku dnu

# FW CONNTRACK - čo odíde z firewallu von, nech sa naň aj vráti
$I -A INPUT -i eth0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# VLAN CONNTRACK - čo odíde z VLAN rozhraní von, nech sa na ne aj vráti
$I -A FORWARD -i eth0 -o eth1.10 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
$I -A FORWARD -i eth0 -o eth1.20 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

########## SNAT ##########
# Našej skupine boli pridelené verejné adresy 158.193.139.74 a .75
# Na tieto adresy prekladáme požiadavky pochádzajúce z vnútornej siete,
# pretože privátne adresy nie sú smerovateľné na vo verejnej sieti.
$I -t nat -A POSTROUTING -o eth0 -j SNAT --to-source 158.193.139.74
$I -t nat -A POSTROUTING -o eth0 -j SNAT --to-source 158.193.139.75

########## VLAN ROUTING ############
# Povolíme smerovanie medzi VLANami
$I -A FORWARD -i eth1.10 -o eth1.20 -j ACCEPT
$I -A FORWARD -i eth1.20 -o eth1.10 -j ACCEPT

########## ICMP ############
# Povolíme PINGy na firewall zvonku aj zvnútra
$I -A INPUT -p icmp -j ACCEPT

# Povolíme PINGy z VLANiek von
$I -A FORWARD -i eth1.10 -o eth0 -p icmp -j ACCEPT
$I -A FORWARD -i eth1.20 -o eth0 -p icmp -j ACCEPT

########## SSH ##########
# Povolíme SSH na firewall zvonku dnu
$I -A INPUT -p tcp --dport 22 -j ACCEPT

# Návrat SSH na FW, pokiaľ sa z neho pripájame niekam inam na SSH
# v rámci lokálnej siete
$I -A INPUT -i eth1.10 -p tcp --sport 22 -j ACCEPT
$I -A INPUT -i eth1.20 -p tcp --sport 22 -j ACCEPT

# Povolíme preposielanie SSH požiadaviek pre server S1 zvonku dnu ...
$I -t nat -A PREROUTING -d 158.193.139.74 -p tcp --dport 3002 -j DNAT --to-destination 192.168.0.2:22
$I -A FORWARD -p tcp -d 192.168.0.2 --dport 22 -j ACCEPT
$I -A FORWARD -p tcp -s 192.168.0.2 --sport 22 -j ACCEPT
# ... a zvnútra von - musíme povoliť obidva smery: od FW k S1 a naopak
$I -A FORWARD -d 192.168.0.2 -p tcp --dport 22 -j ACCEPT
$I -A FORWARD -s 192.168.0.2 -p tcp --sport 22 -j ACCEPT

# Povolíme preposielanie SSH požiadaviek pre server S2 zvonku dnu ...
$I -t nat -A PREROUTING -d 158.193.139.74 -p tcp --dport 3003 -j DNAT --to-destination 192.168.0.3:22
$I -A FORWARD -p tcp -d 192.168.0.3 --dport 22 -j ACCEPT
$I -A FORWARD -p tcp -s 192.168.0.3 --sport 22 -j ACCEPT
# ... a zvnútra von - musíme povoliť obidva smery: od FW k S1 a naopak
$I -A FORWARD -d 192.168.0.3 -p tcp --dport 22 -j ACCEPT
$I -A FORWARD -s 192.168.0.3 -p tcp --sport 22 -j ACCEPT

########## DNS ############
# Povolíme DNS pre FW
$I -A INPUT -p udp --sport 53 -j ACCEPT
$I -A INPUT -p udp --dport 53 -j ACCEPT

# Povolíme DNS zvnútra von
$I -A FORWARD -i eth1.10 -o eth0 -p tcp --dport 53 -j ACCEPT
$I -A FORWARD -i eth1.10 -o eth0 -p udp --dport 53 -j ACCEPT
$I -A FORWARD -i eth1.20 -o eth0 -p tcp --dport 53 -j ACCEPT
$I -A FORWARD -i eth1.20 -o eth0 -p udp --dport 53 -j ACCEPT

# Povolíme MASTER DNS (S1) pre lokálnu sieť
$I -A FORWARD -d 192.168.0.2 -p tcp --dport 53 -j ACCEPT
$I -A FORWARD -s 192.168.0.2 -p tcp --sport 53 -j ACCEPT
$I -A FORWARD -d 192.168.0.2 -p udp --dport 53 -j ACCEPT
$I -A FORWARD -s 192.168.0.2 -p udp --sport 53 -j ACCEPT

# Povolíme SLAVE DNS (S2) pre lokálnu sieť
$I -A FORWARD -d 192.168.0.3 -p tcp --dport 53 -j ACCEPT
$I -A FORWARD -s 192.168.0.3 -p tcp --sport 53 -j ACCEPT
$I -A FORWARD -d 192.168.0.3 -p udp --dport 53 -j ACCEPT
$I -A FORWARD -s 192.168.0.3 -p udp --sport 53 -j ACCEPT

# Povolíme MASTER DNS (S1) zvonku dnu
$I -t nat -A PREROUTING -d 158.193.139.74 -p tcp --dport 53 -j DNAT --to-destination 192.168.0.2
$I -t nat -A PREROUTING -d 158.193.139.74 -p udp --dport 53 -j DNAT --to-destination 192.168.0.2

# Povolíme SLAVE DNS (S2) zvonku dnu
$I -t nat -A PREROUTING -d 158.193.139.75 -p tcp --dport 53 -j DNAT --to-destination 192.168.0.3
$I -t nat -A PREROUTING -d 158.193.139.75 -p udp --dport 53 -j DNAT --to-destination 192.168.0.3

########## NTP ##########
# Povolíme NTP pre FW zvonku dnu
$I -A INPUT -p udp --sport 123 -j ACCEPT

# Povolíme NTP lokálnu sieť
$I -A FORWARD -d 192.168.0.3 -p udp --dport 123 -j ACCEPT
$I -A FORWARD -s 192.168.0.3 -p udp --sport 123 -j ACCEPT

# Povolíme NTP zvonku dnu
$I -t nat -A PREROUTING -d 158.193.139.74 -p udp --dport 123 -j DNAT --to-destination 192.168.0.3:123
$I -t nat -A PREROUTING -d 158.193.139.75 -p udp --dport 123 -j DNAT --to-destination 192.168.0.3:123

########## HTTP ##########
#Povol HTTP von
$I -A FORWARD -i eth1.10 -o eth0 -p tcp --dport 80 -j ACCEPT
$I -A FORWARD -i eth1.20 -o eth0 -p tcp --dport 80 -j ACCEPT

# Povolíme HTTP lokálnu sieť
$I -A FORWARD -d 192.168.0.2 -p tcp --dport 80 -j ACCEPT
$I -A FORWARD -s 192.168.0.2 -p tcp --sport 80 -j ACCEPT

#HTTP zvonku dnu
$I -t nat -A PREROUTING -d 158.193.139.74 -p tcp --dport 80 -j DNAT --to-destination 192.168.0.2

########## HTTPS ##########
#Povol HTTPS von
$I -A FORWARD -i eth1.10 -o eth0 -p tcp --dport 443 -j ACCEPT
$I -A FORWARD -i eth1.20 -o eth0 -p tcp --dport 443 -j ACCEPT

# Povolíme HTTPS lokálnu sieť
$I -A FORWARD -d 192.168.0.2 -p tcp --dport 443 -j ACCEPT
$I -A FORWARD -s 192.168.0.2 -p tcp --sport 443 -j ACCEPT

# HTTP zvonku dnu
$I -t nat -A PREROUTING -d 158.193.139.74 -p tcp --dport 443 -j DNAT --to-destination 192.168.0.2

########## FTP ##########
# Povolíme FTP zvnútra von pre servery aj desktopy
$I -A FORWARD -i eth1.10 -o eth0 -p tcp --dport 20 -j ACCEPT
$I -A FORWARD -i eth1.10 -o eth0 -p tcp --dport 21 -j ACCEPT
$I -A FORWARD -i eth1.20 -o eth0 -p tcp --dport 20 -j ACCEPT
$I -A FORWARD -i eth1.20 -o eth0 -p tcp --dport 21 -j ACCEPT

########## DHCP ##########
#Povolíme DHCP v lokálnej sieti
$I -I FORWARD -i eth1.10 -p udp --dport 67:68 --sport 67:68 -j ACCEPT
$I -I FORWARD -i eth1.20 -p udp --dport 67:68 --sport 67:68 -j ACCEPT

########## SMTP ##########
# Povolíme preposielanie SMTP požiadaviek v lokálnej sieti na/z SMTP server
$I -A FORWARD -p tcp -d 192.168.0.3 --dport 25 -j ACCEPT
$I -A FORWARD -p tcp -s 192.168.0.3 --sport 25 -j ACCEPT

# Povolíme SMTP zvonku dnu
$I -t nat -A PREROUTING -p tcp --dport 25 -j DNAT --to-destination 192.168.0.3:25

########## IMAP ##########
$I -A FORWARD -p tcp -d 192.168.0.3 --dport 143 -j ACCEPT
$I -A FORWARD -p tcp -s 192.168.0.3 --sport 143 -j ACCEPT




# Logovanie do /var/messages/kern.log kvôli ladeniu
$I -A INPUT -j LOG
$I -A FORWARD -j LOG

# Zapneme IP Forwarding pre iptables, aby fungovali "FORWARD" príkazy
echo 1 > /proc/sys/net/ipv4/ip_forward
